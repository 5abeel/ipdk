# Native Install

This method is supportd for either installing and using IPDK in a VM or on a
host natively. Networking Recipewill run natively on the host or inside of a VM, which
is different than the containerized version of IPDK, which runs networking
recipe as a container.

## Steps To Install

Note this method is using Vagrant with Virtualbox. Make sure you have nested
virtualization enabled on your guest VM. There are many articles published on
how to do this, but [this](https://stackoverflow.com/questions/54251855/virtualbox-enable-nested-vtx-amd-v-greyed-out)
one is quite useful.

### Bringup the Vagrant VM:
```
$ cd vagrant-native
$ vagrant up
```

### Login to the VM
```
$ vagrant ssh
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-31-generic x86_64)

                  ubuntu-20.04-amd64-docker (virtualbox)
                 _____ _____ _____ _____ _____ _____ _____
                |  |  |  _  |   __| __  |  _  |   | |_   _|
                |  |  |     |  |  |    -|     | | | | | |
                 \___/|__|__|_____|__|__|__|__|_|___| |_|
                       Sat May 23 14:38:33 UTC 2020
                            Box version: 0.1.1

  System information as of Wed 22 Dec 2021 05:47:40 PM UTC

  System load:  1.08               Processes:                141
  Usage of /:   12.1% of 38.65GB   Users logged in:          0
  Memory usage: 3%                 IPv4 address for docker0: 172.17.0.1
  Swap usage:   0%                 IPv4 address for eth0:    10.0.2.15

vagrant@ubuntu2004:~$
```

### Run the install script to install all dependencies and build components.

*NOTE*: This takes a long time, You also need to run these as root.

Without a proxy:

```
vagrant@ubuntu2004:~$ sudo su -
root@ubuntu2004:~# SCRIPT_DIR=/git/ipdk/build/networking/scripts /git/ipdk/build/networking/scripts/host_install.sh
```

If using a proxy:

```
vagrant@ubuntu2004:~$ sudo su -
root@ubuntu2004:~# SCRIPT_DIR=/git/ipdk/build/networking/scripts /git/ipdk/build/networking/scripts/host_install.sh -p [proxy name]
```

If your source directory is in a different location, such as `/opt/src/ipdk`:

```
vagrant@ubuntu2004:~$ sudo su -
root@ubuntu2004:~# SCRIPT_DIR=/git/ipdk/build/networking/scripts /git/ipdk/build/networking/scripts/host_install.sh -d /opt/src/ipdk
```

Note: To skip installing and building dependencies in the future, add a `-s`
flag to the host_install.sh script.

### Install all networking recipe modules 

```
root@ubuntu2004:~#./install_networking_recipe_all_modules.sh /root
```

### Set environment variables

```
export SDE_INSTALL=/root/p4-sde/install
export IPDK_RECIPE=/root/networking-recipe
export DEPEND_INSTALL=/root/networking-recipe/install
export PKG_CONFIG_PATH=${SDE_INSTALL}/lib64/pkgconfig
```

### Run Networking Recipe

#### Set up the environment required by infrap4d

```
cd $IPDK_RECIPE
source ./scripts/dpdk/setup_env.sh $IPDK_RECIPE $SDE_INSTALL $DEPEND_INSTALL
sudo ./scripts/dpdk/copy_config_files.sh $IPDK_RECIPE $SDE_INSTALL
```

#### Set hugepages required for DPDK

```
sudo ./scripts/dpdk/set_hugepages.sh
```

#### Export all environment variables to sudo user

```
alias sudo='sudo PATH="$PATH" HOME="$HOME" LD_LIBRARY_PATH="$LD_LIBRARY_PATH" SDE_INSTALL="$SDE_INSTALL"'
```

#### Run the infrap4d daemon

```
cd $IPDK_RECIPE
sudo ./install/sbin/infrap4d
```

### Run a sample program

```
cd $IPDK_RECIPE
source ./scripts/setup_env.sh $IPDK_RECIPE $SDE_INSTALL $DEPEND_INSTALL
./scripts/copy_config_files.sh $IPDK_RECIPE $SDE_INSTALL
alias sudo='sudo PATH="$PATH" HOME="$HOME" LD_LIBRARY_PATH="$LD_LIBRARY_PATH" SDE_INSTALL="$SDE_INSTALL"'
```

#### Create 2 TAP ports

```
cd $IPDK_RECIPE
sudo ./install/bin/gnmi-ctl set "device:virtual-device,name:TAP0,pipeline-name:pipe,mempool-name:MEMPOOL0,mtu:1500,port-type:TAP"
sudo ./install/bin/gnmi-ctl set "device:virtual-device,name:TAP1,pipeline-name:pipe,mempool-name:MEMPOOL0,mtu:1500,port-type:TAP"
ifconfig TAP0 up
ifconfig TAP1 up
```

Note: See gnmi-ctl Readme for more information on the gnmi-ctl utility.


### Create P4 artifacts

```
export OUTPUT_DIR=/root/examples/simple_l3
mkdir $OUTPUT_DIR/pipe

/root/p4c/install/bin/p4c-dpdk --arch pna --target dpdk \
    --p4runtime-files $OUTPUT_DIR/p4Info.txt \
    --bf-rt-schema $OUTPUT_DIR/bf-rt.json \
    --context $OUTPUT_DIR/pipe/context.json \
    -o $OUTPUT_DIR/pipe/simple_l3.spec $OUTPUT_DIR/simple_l3.p4
```

Note: The above commands will generate three files (p4Info.txt, bf-rt.json, and context.json).

#### Modify the simple l3 configuration file

Modify simple_l3.conf file to provide the below paths for bfrt-config, context, and config at their respective places in the configuration file:
  1. "bfrt-config": "/root/examples/simple_l3/bf-rt.json"
  2. "context": "/root/examples/simple_l3/pipe/context.json"
  3. "config": "/root/examples/simple_l3/pipe/simple_l3.spec"

#### TDI pipeline builder

TDI pipeline builder combines the artifacts generated by p4c compiler to generate a single bin file to be pushed from the controller. Generate binary executable using tdi-pipeline builder command below:

```
cd $IPDK_RECIPE
./install/bin/tdi_pipeline_builder \
    --p4c_conf_file=$OUTPUT_DIR/simple_l3.conf \
    --bf_pipeline_config_binary_file=$OUTPUT_DIR/simple_l3.pb.bin
```

### Set forwarding pipeline

```
cd $IPDK_RECIPE
sudo ./install/bin/p4rt-ctl set-pipe br0 $OUTPUT_DIR/simple_l3.pb.bin $OUTPUT_DIR/p4Info.txt
```

### Configure forwarding rules

```
cd $IPDK_RECIPE
sudo  ./install/bin/p4rt-ctl add-entry br0 ingress.ipv4_host "hdr.ipv4.dst_addr=1.1.1.1,action=ingress.send(0)"
sudo  ./install/bin/p4rt-ctl add-entry br0 ingress.ipv4_host "hdr.ipv4.dst_addr=2.2.2.2,action=ingress.send(1)"
```

Note: See p4rt-ctl Readme for more information on p4rt-ctl utility.

### Test traffic between TAP0 and TAP1

Send packet from TAP 0 to TAP1 using scapy and listen on TAP1 using tcpdump.

```
sendp(Ether(dst="00:00:00:00:03:14", src="a6:c0:aa:27:c8:2b")/IP(src="192.168.1.10", dst="2.2.2.2")/UDP()/Raw(load="0"*50), iface='TAP0')
```
